parameters:
  - name: environment
    type: string
  - name: tfvarspath
    type: string
  - name: runApply
    type: boolean
    default: false

jobs: 
  - job: PreDeploy_${{parameters.environment}}
    displayName: "${{ parameters.environment }} - Terraform Plan and Validate"
    pool: digwi-pool
    steps:
      - task: AzureCLI@2
        displayName: Terraform Init via WIF
        inputs:
          azureSubscription: 'WIF-ServiceConnection'
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          workingDirectory: '$(System.DefaultWorkingDirectory)/todo-infra'
          inlineScript: |
            terraform init \
              -backend-config="storage_account_name=digwitfstatestorage" \
              -backend-config="container_name=tfstate" \
              -backend-config="key=${{ parameters.environment }}.tfstate" \
              -backend-config="resource_group_name=rg-tfstate" \
              -backend-config="subscription_id=ab1ac19d-06cd-4ac2-b289-cbb67e904a92" \
              -backend-config="use_azuread_auth=true"

      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'validate'
          workingDirectory: '$(System.DefaultWorkingDirectory)/todo-infra'

      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'plan'
          commandOptions: '-var-file=${{ parameters.tfvarspath }}'
          workingDirectory: '$(System.DefaultWorkingDirectory)/todo-infra'
          environmentServiceNameAzureRM: 'WIF-ServiceConnection'
          environmentAzureRmOverrideSubscriptionID: 'ab1ac19d-06cd-4ac2-b289-cbb67e904a92'

  - job: ManualApproval${{parameters.environment}}
    displayName: "${{ parameters.environment }} - Manual Approval"
    dependsOn: PreDeploy_${{parameters.environment}}
    pool: server
    condition: succeeded()
    timeoutInMinutes: 4320 # job times out in 3 days
    steps:
    - task: ManualValidation@1
      timeoutInMinutes: 1440 # task times out in 1 day
      inputs:
        notifyUsers: |
          digwijayp@gmail.com          
        instructions: 'Please validate the build configuration and resume'
        
              
  - job: Deploy_${{parameters.environment}}
    displayName: "${{ parameters.environment }} - Terraform Apply"
    dependsOn: ManualApproval${{parameters.environment}}
    pool: digwi-pool
    condition: and(succeeded(), eq('${{ parameters.runApply }}', 'true'))
    steps:
      - task: AzureCLI@2
        displayName: Terraform Init via WIF
        inputs:
          azureSubscription: 'WIF-ServiceConnection'
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          workingDirectory: '$(System.DefaultWorkingDirectory)/todo-infra'
          inlineScript: |
            terraform init \
              -backend-config="storage_account_name=digwitfstatestorage" \
              -backend-config="container_name=tfstate" \
              -backend-config="key=${{ parameters.environment }}.tfstate" \
              -backend-config="resource_group_name=rg-tfstate" \
              -backend-config="subscription_id=ab1ac19d-06cd-4ac2-b289-cbb67e904a92" \
              -backend-config="use_azuread_auth=true"

      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'apply'
          commandOptions: '-auto-approve -var-file=${{ parameters.tfvarspath }}'
          workingDirectory: '$(System.DefaultWorkingDirectory)/todo-infra'
          environmentServiceNameAzureRM: 'WIF-ServiceConnection'
          environmentAzureRmOverrideSubscriptionID: 'ab1ac19d-06cd-4ac2-b289-cbb67e904a92'
          
